<canvas id="canvas" width="400" height="400"></canvas>

<script>
	
	var initialized;
	var level;
	var snake;
	var keys;
	var apple;

	window.onload = function(){
		// Canvas
		canvas = document.getElementById("canvas");
		ctx = canvas.getContext("2d");
		// Keyboard
		document.addEventListener("keydown", keyboard);
		initialized = false;
		// Start game
		setInterval(game, 1000/15);
	}

	function Level(color, pixelSize){
		this.color = color;
		this.pixelSize = pixelSize;
		this.pixels = {x: canvas.width/pixelSize, y: canvas.height/pixelSize};
		
		// Draw level and score.
		this.render = function(){
			ctx.fillStyle = this.color;
			ctx.fillRect(0, 0, canvas.width, canvas.height);
			ctx.fillStyle = "white";
			var score = snake.body.length;
			ctx.font = "15px Arial";
			ctx.fillText(score,canvas.width/2,20);
		}
	}

	function Snake(color, x, y, xSpeed, ySpeed, size){
		this.color = color;
		this.xSpeed = xSpeed;
		this.ySpeed = ySpeed;
		this.x = x;
		this.y = y;
		// Body contains X and Y positions for all bodyparts.
		this.body = [{x: x, y: y}];
		this.size = size;

		this.update = function(){
			// Update position
			this.x += this.xSpeed;
			this.y += this.ySpeed;			

			// Screen wrapping
			this.x = mod(this.x, level.pixels.x);
			this.y = mod(this.y, level.pixels.y);

			this.collision();

			// Add the new position to our body.
			this.body.push({x: this.x, y: this.y});
			// Remove tail.
			while(this.size < this.body.length){
				this.body.shift(); // This removes the last element of the body;
			}
		}

		// Collision check (self or apple).
		this.collision = function(){
			for(var i in this.body){
				if(this.x == this.body[i].x && this.y == this.body[i].y){
					this.size = 1;
				} else if(this.x == apple.x && this.y == apple.y){
					this.grow();
					apple.update();
				}
			}
		}

		this.grow = function(){
			this.size++;
		}

		this.render = function(){
			ctx.fillStyle = this.color;
			for(var i in this.body){
				var bodyPart = this.body[i];
				ctx.fillRect(level.pixelSize*bodyPart.x+1, level.pixelSize*bodyPart.y+1, level.pixelSize-1, level.pixelSize-1);
			}
		}
	}

	function Apple(color){
		this.color = color;
		this.x = 10;
		this.y = 10;

		// Draw apple
		this.render = function(){
			ctx.fillStyle = this.color;
			ctx.fillRect(this.x*level.pixelSize+1, this.y*level.pixelSize+1, level.pixelSize-1, level.pixelSize-1);
		}

		// Spawn apple on random place.
		this.update = function(){
			var maxX = level.pixels.x-1;
			var minX = 0;
			this.x = Math.floor(Math.random() * (maxX - minX + 1)) + minX;
			var maxY = level.pixels.y-1;
			var minY = 0;
			this.y = Math.floor(Math.random() * (maxY - minY + 1)) + minY;
			for(var i in snake.body){
				if(snake.body[i].x == this.x && snake.body[i].y == this.y){
					this.update();
					break;
				}
			}
		}
	}

	// Game initialization.
	function initialize(){
		if(!initialized){
			// Objects
			level = new Level("#739218", 10);
			snake = new Snake("white", canvas.width/2, canvas.height/2, 0, 0, 1);
			apple = new Apple("white");
			keys = [];
			initialized = true;
		}
	};

	// Game loop.
	function game() {
		initialize();
		readinput();
		updateState();
		render();
	}

	// Update all objects.
	function updateState(){
		snake.update();
	}

	// Render all objects.
	function render(){
		level.render();
		snake.render();
		apple.render();
	}

	// Push into array so you can perform quick turns.
	function keyboard(evt){
		switch(evt.keyCode){
			case 32:
				keys.push(32);
				break;
		    case 37:
				keys.push(37);
		        break;
		    case 38:
				keys.push(38);
		        break;
		    case 39:
				keys.push(39);
		        break;
		    case 40:
				keys.push(40);
		        break;
		}
	}

	function readinput(){
		switch(keys.shift()){
			case 37: //left
				if(snake.xSpeed != 1){
					snake.xSpeed = -1;
					snake.ySpeed = 0;
				}
		        break;
		    case 38: //up
				if(snake.ySpeed != 1){
					snake.xSpeed = 0;
					snake.ySpeed = -1;
				}
				break;
			case 39: //right
				if(snake.xSpeed != -1){
					snake.xSpeed = 1;
					snake.ySpeed = 0;
				}
				break;
			case 40: //down
				if(snake.ySpeed != -1){
					snake.xSpeed = 0;
					snake.ySpeed = 1;
				}
				break;
		}
	}

	// Regular mod returns negative numbers... :(
	function mod(x, m) {
		return (x%m + m)%m;
	}
</script>
